<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>あいうえお入力補助</title>
<style>
  :root{
    --bg:#ffffff; --fg:#1f2937; --muted:#6b7280; --bord:#e5e7eb; --hint:#374151;
    --btn:#f3f4f6; --btn-h:#e5e7eb; --accent:#2563eb; --accent-2:#e0e7ff;
  }
  body{margin:0; background:var(--bg); color:var(--fg);
       font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Noto Sans JP","Meiryo",sans-serif}
  .wrap{max-width:980px; margin:22px auto; padding:0 16px}
  h1{font-size:20px; margin:0 0 10px}
  .toolbar{
    display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    position:sticky; top:0; background:var(--bg); padding:8px 0; z-index:5; border-bottom:1px solid var(--bord);
  }
  .btn{
    appearance:none; border:1px solid var(--bord); background:var(--btn);
    padding:8px 12px; border-radius:8px; cursor:pointer; font-weight:600; font-size:14px;
  }
  .btn:hover{background:var(--btn-h)}
  .btn.primary{background:var(--accent); color:#fff; border-color:var(--accent)}
  .btn.primary:hover{filter:brightness(0.95)}
  .btn.danger{background:#fee2e2; color:#b91c1c; border-color:#fecaca}
  .btn.danger:hover{background:#fecaca}
  .hint{font-size:13px; color:var(--muted)}
  textarea.editor{
    margin-top:10px; width:100%; min-height:140px; font-size:18px; line-height:1.8;
    border:1px solid var(--bord); border-radius:10px; padding:12px; resize:vertical; outline:none;
  }
  textarea.editor:focus{box-shadow:0 0 0 3px var(--accent-2); border-color:#c7d2fe}
  .section{margin-top:18px}
  .section h3{margin:12px 0 6px; font-size:14px; color:var(--hint)}

  /* 行×列グリッド（ボタンを正方形に並べる） */
  .kana-matrix{
    display:grid; gap:6px;
    grid-auto-rows: 42px; /* 行の高さ */
  }
  .kana-btn{
    width:42px; height:42px; font-size:18px; line-height:1;
    border:1px solid var(--bord); background:#fafafa; border-radius:8px; cursor:pointer; user-select:none;
  }
  .kana-btn:hover{background:#f3f4f6}
  .kana-btn[disabled]{visibility:hidden} /* 空セルは見た目非表示でマス目維持 */

  .hr{height:1px; background:var(--bord); margin:16px 0}
  .toast{
    position:fixed; left:50%; transform:translateX(-50%); bottom:24px; background:#111827; color:#fff;
    padding:10px 14px; border-radius:10px; opacity:0; pointer-events:none; transition:opacity .2s ease; font-size:13px;
  }
  .toast.show{opacity:0.95}
</style>
</head>
<body>
<div class="wrap">
  <h1>あいうえお入力補助</h1>

1. あいうえお表で文字を入力します。<br>
2. 変換したい文字をマウスで範囲選択します。<br>
3. キーボードの変換を押して変換します。<br>
4. 全ての文字を入力したらコピーで内容をコピーします。<br><br>

  <div class="toolbar" role="toolbar" aria-label="操作">
    <button id="selectRunBtn"  class="btn primary" aria-label="かなブロックを選択">かなブロック選択</button>
    <button id="selectPrevBtn" class="btn" aria-label="直前のかなを選択">直前のかなを選択</button>
    <button id="copyBtn"       class="btn" aria-label="コピー">コピー</button>
    <button id="clearBtn"      class="btn danger" aria-label="削除">削除</button>
    <span class="hint">選択できたらキーボードの <b>変換</b> でIME候補を表示できます</span>
  </div>

  <textarea id="editor" class="editor" aria-label="文字入力欄"
    placeholder="ここに入力します"></textarea>

  <div class="hr"></div>

  <!-- 清音：5行×10列 -->
  <section class="section">
    <div class="kana-matrix" id="seion-matrix" aria-label="清音 5行×10列"></div>
  </section>
</div>

<div id="toast" class="toast" role="status" aria-live="polite"></div>

<script>
(() => {
  const $ = s => document.querySelector(s);
  const editor = $('#editor');
  const toast  = $('#toast');

  /* ===== データ定義（行= あ/い/う/え/お） ===== */

  // 清音：5行×10列（列= あ,か,さ,た,な,は,ま,や,ら,わ）
  const SEION = [
    // a行         k    s    t    n    h    m    y    r    w
    ['あ','か','さ','た','な','は','ま','や','ら','わ', 'が','ざ','だ','ば','ぱ','ぁ','ゃ','っ','「','『','、','？'],
    // i行
    ['い','き','し','ち','に','ひ','み','','り','','ぎ','じ','ぢ','び','ぴ','ぃ','ゅ','ー','」','』','。','！'],
    // u行
    ['う','く','す','つ','ぬ','ふ','む','ゆ','る','','ぐ','ず','づ','ぶ','ぷ','ぅ','ょ','・','（','）','…','〜'],
    // e行
    ['え','け','せ','て','ね','へ','め','','れ','','げ','ぜ','で','べ','ぺ','ぇ','0','1','2','3','4',''],
    // o行
    ['お','こ','そ','と','の','ほ','も','よ','ろ','ん','ご','ぞ','ど','ぼ','ぽ','ぉ','5','6','7','8','9','']
  ];

  // 濁音：列= が,ざ,だ,ば（空きを '' で埋める）
  const DAKUON = [
    ['が','ざ','だ','ば',''], // a行
    ['ぎ','じ','ぢ','び',''], // i行
    ['ぐ','ず','づ','ぶ',''], // u行
    ['げ','ぜ','で','べ',''], // e行
    ['ご','ぞ','ど','ぼ','']  // o行
  ];

  // 半濁音：列= ぱ だけ（1列）
  const HANDAKU = [
    ['ぱ'], ['ぴ'], ['ぷ'], ['ぺ'], ['ぽ']
  ];

  // 小文字・拗音・記号：5行×N列（列数は適当。空きは ''）
  const SMALLS = [
    ['ぁ','ゃ','っ','「','『','、','？'],
    ['ぃ','ゅ','ー','」','』','。','！'],
    ['ぅ','ょ','・','（','）','…','〜'],
    ['ぇ','','','','','',''],
    ['ぉ','','','','','','']
  ];

  /* ====== 描画 ====== */

  // 行×列の2次元配列をマトリクス描画
  function renderMatrix(containerId, matrix){
    const box = document.getElementById(containerId);
    // 列数は最長行に合わせる
    const cols = Math.max(...matrix.map(r => r.length));
    box.style.gridTemplateColumns = `repeat(${cols}, 42px)`;

    matrix.forEach(row => {
      // 足りない分は空文字でパディング
      const padded = row.concat(Array(cols - row.length).fill(''));
      padded.forEach(ch => {
        const b = document.createElement('button');
        b.className = 'kana-btn';
        if (ch) {
          b.textContent = ch;
          b.addEventListener('click', () => insertKana(ch));
        } else {
          b.disabled = true; // 空セル
        }
        box.appendChild(b);
      });
    });
  }

  renderMatrix('seion-matrix',   SEION);

  /* ====== 入力欄処理・IME支援 ====== */

  function insertKana(ch){
    editor.focus();
    const {selectionStart:s, selectionEnd:e, value} = editor;
    editor.value = value.slice(0,s) + ch + value.slice(e);
    const pos = s + ch.length;
    editor.setSelectionRange(pos, pos);

    // 直近ブロックを記録
    const block = findKanaRunAround(editor.value, pos, true);
    lastKanaBlock = block;
    showToast('入力しました → 変換キーでIME候補を表示できます');
  }

  const isHiragana = ch => /^[\u3041-\u3096]$/.test(ch);
  const isKatakana = ch => /^[\u30A1-\u30FA\u30FC]$/.test(ch);
  const isKana = ch => isHiragana(ch) || isKatakana(ch);

  function findKanaRunAround(text, cursorPos){
    // cursorPos をはさむ連続かなブロックを返す
    let i = cursorPos - 1;
    if (!(i>=0 && isKana(text[i])) && cursorPos<text.length && isKana(text[cursorPos])) i = cursorPos;
    if (i < 0 || !isKana(text[i])) return null;
    let start = i, end = i+1;
    while (start-1>=0 && isKana(text[start-1])) start--;
    while (end<text.length && isKana(text[end])) end++;
    return {start, end};
  }

  function selectKanaRun(){
    editor.focus();
    const {selectionStart:s, selectionEnd:e, value} = editor;
    if (e > s){ editor.setSelectionRange(s, e); hintIME(); return; }
    const run = findKanaRunAround(value, s);
    if (!run){ showToast('かなの連続ブロックが見つかりません'); return; }
    editor.setSelectionRange(run.start, run.end);
    hintIME(); lastKanaBlock = run;
  }

  function selectPrevKanaRun(){
    editor.focus();
    if (!lastKanaBlock){ showToast('直前のかなブロックがありません'); return; }
    const {start, end} = lastKanaBlock;
    const len = editor.value.length;
    if (start>=0 && end<=len){ editor.setSelectionRange(start, end); hintIME(); }
    else{ showToast('直前ブロックは無効になりました'); }
  }

  function hintIME(){ showToast('選択中：Space / 変換キーでIME候補を表示'); }
  function showToast(msg){
    toast.textContent = msg;
    toast.classList.add('show');
    clearTimeout(showToast._t);
    showToast._t = setTimeout(()=>toast.classList.remove('show'), 1200);
  }

  async function copyText(){
    try{ await navigator.clipboard.writeText(editor.value); showToast('コピーしました'); }
    catch{
      const ta=document.createElement('textarea'); ta.value=editor.value; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy'); ta.remove(); showToast('コピーしました（フォールバック）');
    }
    editor.focus();
  }
  function clearText(){ editor.value=''; lastKanaBlock=null; editor.focus(); }

  let lastKanaBlock = null;

  $('#selectRunBtn').addEventListener('click', selectKanaRun);
  $('#selectPrevBtn').addEventListener('click', selectPrevKanaRun);
  $('#copyBtn').addEventListener('click', copyText);
  $('#clearBtn').addEventListener('click', clearText);

  // ショートカット：Ctrl+J = かなブロック選択 / Ctrl+K = 直前ブロック選択
  editor.addEventListener('keydown',(e)=>{
    if ((e.ctrlKey||e.metaKey) && !e.shiftKey && !e.altKey){
      if (e.key.toLowerCase()==='j'){ e.preventDefault(); selectKanaRun(); }
      if (e.key.toLowerCase()==='k'){ e.preventDefault(); selectPrevKanaRun(); }
    }
  });
})();
</script>
</body>
</html>
